Ниже полное ТЗ на твой BestChange‑проект с учётом суммы и marks.

1. Цель и задачи
Разработать сервис, который по данным BestChange API находит лучший вариант обмена по заданной валютной паре, сумме и набору marks (меток обменника).
​

Предоставить HTTP API и (опционально) CLI для поиска лучшего курса, пригодные для продакшена и демонстрации в портфолио.
​

2. Функциональные требования
Основные возможности сервиса:

Получение списка валют из BestChange (currencies) и работа по их ID.
​

Получение курсов обмена по паре from_id → to_id из BestChange v2 /rates/{from}-{to}.
​

Фильтрация курсов по:

сумме, которую пользователь отдаёт (ограничения inmin/inmax);
​

набору marks, которые должны быть у обменника (manual, verify, floating и др.).
​

Выбор одного “лучшего” курса по формальному критерию (см. раздел 4).

Возврат полной информации о найденном обмене (exchanger_id, курс, резерв, marks и т.п.).
​

Дополнительно (по желанию):

Endpoint для просмотра сырых курсов без фильтрации.

Endpoint для получения списка доступных marks с описанием (из документации BestChange).
​

3. Внешний API сервиса
3.1. Endpoint: поиск лучшего курса
Метод и путь

POST /api/v1/best-rate

Тело запроса

json
{
  "from_id": 1,
  "to_id": 10,
  "amount": 1000,
  "marks": ["manual", "reg"]
}
Параметры:

from_id (int, required) — ID валюты “отдаёте” по BestChange.
​

to_id (int, required) — ID валюты “получаете”.
​

amount (float, required) — сумма во входной валюте, которую пользователь хочет отдать.
​

marks (array[string], optional) — список требуемых marks обменника, как в статье “List of used marks”.
​

Ответ 200 OK

json
{
  "from_id": 1,
  "to_id": 10,
  "amount": 1000,
  "marks": ["manual", "reg"],
  "best_rate": {
    "exchanger_id": 123,
    "rate": "0.00002345",
    "rankrate": "0.00002360",
    "inmin": "100",
    "inmax": "5000",
    "reserve": "123456.78",
    "marks": ["manual", "reg"],
    "from_amount": "1000",
    "to_amount": "0.02345"
  },
  "source": "bestchange"
}
rate / rankrate берутся из ответа BestChange v2 (курс и курс с учётом комиссий/рейтинга).
​

inmin / inmax — минимальная и максимальная сумма для обмена по этому направлению.
​

reserve — доступный резерв целевой валюты у обменника.
​

marks — список меток для конкретного направления/обменника (manual, floating, additional fee и др.).
​

from_amount и to_amount рассчитываются в сервисе по выбранному курсу.
​

Ответы об ошибках

400 Bad Request — некорректный JSON, amount <= 0, отсутствуют обязательные поля.

422 Unprocessable Entity — после всех фильтров ни одного подходящего курса не найдено.

502 Bad Gateway — ошибка обращения к BestChange API или некорректный ответ.
​

3.2. Optional: CLI команда
Формат:

bash
bestchange best --from 1 --to 10 --amount 1000 --marks manual,reg
Выводит лучший курс в текстовом виде (exchanger_id, rate, to_amount, marks).

4. Бизнес‑логика выбора курса
4.1. Загрузка данных
Сервис обращается к BestChange API v2:

GET https://bestchange.app/v2/{apiKey}/rates/{from_id}-{to_id}.
​

Ответ содержит массив вариантов обмена с курсом, лимитами, резервом и дополнительной информацией.
​

4.2. Фильтр по сумме
Для каждого курса:

Преобразовать inmin и inmax к числам.
​

Условие допуска курса:

amount >= inmin.

Если inmax > 0, то дополнительно amount <= inmax.
​

Курсы, не удовлетворяющие этим условиям, исключаются из дальнейшего рассмотрения.

4.3. Фильтр по marks
Если marks не указан или пустой — фильтрация по marks не применяется.

Если marks указан:

Из ответа BestChange берётся список marks для направления/обменника.
​

Курс допускается, если для каждой пользовательской метки m она присутствует в marks обменника (логика “AND”).
​

Пример: пользователь указал ["manual", "floating"] — подойдут только те курсы, где оба этих значка есть у направления.
​

4.4. Дополнительный фильтр по резерву (опционально)
Если включено в настройках сервиса:

курс допускается только если reserve >= to_amount, либо reserve >= amount * rate.
​

4.5. Критерий “лучший курс”
На массиве отфильтрованных курсов:

Основной критерий:

выбрать запись с минимальным rankrate (рекомендуемый способ учёта рейтинга и комиссий).
​

Вторичный критерий (при равном rankrate):

выбрать курс с максимальным to_amount (что пользователь получает).
​

Если массив пустой:

вернуть доменную ошибку ErrNoSuitableRates, маппится в HTTP 422.

5. Внутренняя архитектура и модели
5.1. Технологический стек
Язык: Go.

HTTP‑фреймворк: Gin (или стандартный net/http, но ориентир — Gin).

CLI: Cobra (опционально).

Формат обмена данными: JSON.

Сетевое взаимодействие с BestChange: http.Client с поддержкой:

gzip;

keep‑alive;

ограничение частоты запросов, как рекомендует BestChange.
​

5.2. Структура проекта
cmd/api/main.go — запуск HTTP API.

cmd/cli/main.go — CLI‑утилита.

internal/bestchange/client.go — низкоуровневый клиент BestChange (currencies, rates…).

internal/bestchange/service.go — бизнес‑логика выбора лучшего курса (фильтры, критерии).

internal/models/models.go — структуры Currency, Rate, BestRateResponse и другие модели.

internal/http/handlers.go — HTTP‑хендлеры (маршруты, валидация, ответы).

5.3. Основные модели (концептуально)
Currency — модель валюты из BestChange (id, name, code, crypto, cash, ps и др.).
​

Rate — модель одного курса из /rates:

ExchangerID, Rate, RankRate, InMin, InMax, Reserve, Marks, поля для расчёта amounts.
​

BestRateRequest — входные параметры API сервиса.

BestRateResponse — результат с лучшим курсом.

6. Нефункциональные требования
Производительность:

время ответа сервиса — не более 1–2 секунд при типичном размере ответа BestChange.
​

Надёжность:

обработка ошибок BestChange (network, 5xx, невалидный JSON) с возвратом 502.

защита от частого дергания API (rate limiting).
​

Логирование:

логировать запросы к BestChange, ошибки, ответы API сервиса (уровни info/error).

Тестирование:

модульные тесты на фильтры по сумме и marks;

тесты на выбор лучшего курса по rankrate и to_amount.

7. Критерии приёмки
При задании разных amount виден корректный отбор по inmin/inmax (некоторые обменники отваливаются, другие появляются).
​

При добавлении marks список потенциальных обменников сужается, и в результате остаются только те, у кого есть все указанные marks.
​

Возвращаемый “лучший” курс совпадает с логикой сортировки/рейтинга BestChange при тех же условиях (по rankrate).
​

Ошибки обрабатываются корректно (400/422/502).

Код структурирован по слоям (client/service/handlers/models), легко расширяется и читается.